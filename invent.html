<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resident Evil RPG - Ficha de Personagem</title>
    <link rel="icon" href="imgs/icon.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="style.css">

    <style>
        /* Estilos Anteriores */
        .map-container {
            position: relative;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #map-image {
            max-width: 100%;
            max-height: 80vh;
        }

        #player-fog-of-war {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            padding: 1rem 1.5rem;
            border-radius: 4px;
            color: #fff;
            font-family: sans-serif;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            animation: slideInNotification 0.3s ease-out;
        }

        .notification.info {
            background-color: #0277BD;
        }

        .notification.success {
            background-color: #2E7D32;
        }

        .notification.error {
            background-color: #C62828;
        }

        @keyframes slideInNotification {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .dice-modal-content .dice-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .dice-option {
            display: flex;
            gap: 10px;
            align-items: center;
            width: 100%;
            justify-content: center;
        }

        .dice-option label {
            color: #c0a050;
            font-size: 1.1rem;
        }

        .dice-option input,
        .dice-option select {
            background-color: #1a1a1a;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 0.5rem;
            border-radius: 4px;
            font-family: 'IM Fell English SC', serif;
            font-size: 1rem;
            text-align: center;
        }

        .dice-option input {
            width: 70px;
        }

        .dice-option select {
            flex-grow: 1;
            max-width: 200px;
            text-align: left;
        }

        /* --- ESTILOS ATUALIZADOS --- */

        /* Layout principal para Desktop */
        @media (min-width: 1024px) {
            body {
                display: flex;
            }

            .container {
                flex-grow: 1;
                margin-right: 370px;
            }

            #player-chat-container {
                position: fixed;
                right: 20px;
                top: 20px;
                bottom: 20px;
                height: calc(100vh - 40px);
                width: 350px;
                max-height: 95vh;
                border-radius: 4px;
                margin-bottom: 0;
            }

            #player-chat-container.collapsed {
                height: 42px;
                bottom: auto;
            }
        }

        /* Design dos atributos */
        .attributes-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .attribute {
            display: flex;
            flex-direction: column;
        }

        .attribute label {
            color: #e0e0e0;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: baseline;
            gap: 8px;
            /* Espa√ßo entre o nome e o modificador */
        }

        .attribute-modifier {
            color: #c0a050;
            font-weight: bold;
        }

        .attribute input {
            width: 100%;
            box-sizing: border-box;
            text-align: center;
            background: #1a1a1a;
            border: 1px solid #444;
            color: #fff;
            padding: 0.4rem;
            font-size: 1.1rem;
        }

        /* --- ESTILOS DO CHAT CORRIGIDOS --- */
        #player-chat-container {
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            /* Impede que o header encolha */
        }

        .chat-messages {
            flex-grow: 1;
            /* Faz a √°rea de mensagens crescer */
            overflow-y: auto;
            /* Adiciona scroll apenas quando necess√°rio */
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .chat-message {
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
            max-width: 90%;
            align-self: flex-start;
            /* Padr√£o: alinhado √† esquerda */
        }

        .message-sender {
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 4px;
            text-shadow: 1px 1px 2px #000;
        }

        .message-text {
            padding: 0.75rem;
            border-radius: 8px;
            word-wrap: break-word;
            line-height: 1.4;
            background-color: rgba(60, 60, 60, 0.8);
            border: 1px solid rgba(80, 80, 80, 0.5);
        }

        .chat-message.own-message {
            align-self: flex-end;
            /* Mensagens pr√≥prias alinhadas √† direita */
            align-items: flex-end;
            /* Conte√∫do interno (nome) alinhado √† direita */
        }

        .chat-message.own-message .message-text {
            background-color: rgba(80, 70, 45, 0.9);
            border: 1px solid rgba(192, 160, 80, 0.3);
        }

        .message-sender.master {
            color: #d4b468;
            font-weight: bold;
        }

        .chat-input {
            flex-shrink: 0;
            /* Impede que o input encolha */
            padding-top: 10px;
            border-top: 1px solid rgba(192, 160, 80, 0.2);
        }

        /* Barra de Scroll Customizada */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background-color: #c0a050;
            border-radius: 4px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background-color: #d4b468;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
</head>

<body>
    <div id="notification-container"></div>

    <div class="container">
        <div class="header-title">
            <h1>INVENT√ÅRIO RESIDENT EVIL</h1>
            <p id="campaign-name-display">Carregando...</p>
        </div>

        <header class="inventory-header">
            <div class="character-info">
                <div id="character-image" class="character-image"></div>
                <input type="file" id="image-upload" accept="image/*" style="display: none;">

                <div class="character-meta">
                    <div class="character-name">
                        <input type="text" id="char-name" placeholder="Nome do Personagem">
                    </div>
                    <div class="equipped-weapon" id="equipped-weapon">
                        <span>Arma: Nenhuma</span>
                    </div>
                </div>

                <div class="action-buttons">
                    <button id="docs-btn" class="re-btn">üìú<span>Documentos</span></button>
                    <button id="map-btn" class="re-btn">üó∫Ô∏è<span>Mapa</span></button>
                    <button id="dice-btn" class="re-btn">üé≤<span>Dados</span></button>
                    <button id="audio-toggle" class="re-btn">
                        <span id="audio-icon">üîá</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="inventory-body">
            <div class="left-panel">
                <div class="service-box">
                    <h3>Vida do Personagem</h3>
                    <div class="health-controls">
                        <button class="health-btn" id="decrease-health-btn">-</button>
                        <div class="health-bar-container">
                            <div id="health-bar-fill" class="health-bar-fill"></div>
                        </div>
                        <button class="health-btn" id="increase-health-btn">+</button>
                    </div>
                    <div id="health-value" style="text-align: center; margin-top: 0.5rem; margin-bottom: 1rem;">100/100
                    </div>
                    <progress id="health" value="100" max="100" style="display: none;"></progress>
                </div>
                <div class="service-box">
                    <h3>Item Selecionado</h3>
                    <div id="selected-item-display" class="selected-item-display">Nenhum</div>
                </div>
                <div class="source-box">
                    <h3>Descri√ß√£o do Item</h3>
                    <div class="item-description" id="item-description">
                        Clique em um item para ver a descri√ß√£o.
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="attributes-box">
                    <h3>Atributos</h3>
                    <div class="attributes-grid">
                        <div class="attribute">
                            <label for="strength">For√ßa: <span class="attribute-modifier"
                                    id="strength-mod"></span></label>
                            <input type="number" id="strength" value="10" min="1" max="20">
                        </div>
                        <div class="attribute">
                            <label for="dexterity">Destreza: <span class="attribute-modifier"
                                    id="dexterity-mod"></span></label>
                            <input type="number" id="dexterity" value="10" min="1" max="20">
                        </div>
                        <div class="attribute">
                            <label for="constitution">Constitui√ß√£o: <span class="attribute-modifier"
                                    id="constitution-mod"></span></label>
                            <input type="number" id="constitution" value="10" min="1" max="20">
                        </div>
                        <div class="attribute">
                            <label for="intelligence">Intelig√™ncia: <span class="attribute-modifier"
                                    id="intelligence-mod"></span></label>
                            <input type="number" id="intelligence" value="10" min="1" max="20">
                        </div>
                        <div class="attribute">
                            <label for="perception">Percep√ß√£o: <span class="attribute-modifier"
                                    id="perception-mod"></span></label>
                            <input type="number" id="perception" value="10" min="1" max="20">
                        </div>
                    </div>
                    <h4>Status Calculados</h4>
                    <div class="stats-grid">
                        <div class="stat"><label>Vida Total:</label><span id="life-total">20</span></div>
                        <div class="stat"><label>Sanidade:</label><span id="sanity-total">100</span></div>
                    </div>
                </div>
            </div>
            <div class="inventory-grid" id="inventory-grid"></div>
        </div>
    </div>
    <footer class="footer">
        <p>Sistema desenvolvido por Jo√£o Piel Neto</p>
        <button id="backToCampaigns" class="re-btn">Voltar para Campanhas</button>
    </footer>
    </div>

    <div id="player-chat-container" class="player-chat-container">
        <div class="chat-header">
            <h3>Chat da Campanha</h3>
            <button id="toggle-chat-btn" title="Minimizar/Maximizar"><i class="fas fa-window-minimize"></i></button>
        </div>
        <div id="chat-messages" class="chat-messages"></div>
        <div class="chat-input">
            <input type="text" id="chat-input-field" placeholder="Digite sua mensagem...">
            <button id="send-chat-btn" class="re-btn">Enviar</button>
        </div>
    </div>


    <audio id="dice-audio" src="sounds/dice1.mp3"></audio>
    <audio id="background-audio" src="sounds/background.mp3" loop></audio>

    <div id="map-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div class="map-controls">
                <h3 id="map-title">Mapa</h3>
            </div>
            <div class="map-container">
                <img id="map-image" src="" alt="Mapa da campanha">
                <canvas id="player-fog-of-war"></canvas>
            </div>
        </div>
    </div>

    <div id="docs-modal" class="modal">
        <div class="modal-content docs-content">
            <span class="close-btn">&times;</span>
            <h3>Documentos e Anota√ß√µes</h3>
            <textarea id="notes-textarea"></textarea>
            <div class="docs-controls">
                <button id="save-notes" class="re-btn">Salvar Notas</button>
            </div>
        </div>
    </div>

    <div id="dice-modal" class="modal">
        <div class="modal-content dice-modal-content">
            <span class="close-btn">&times;</span>
            <h3>Rolagem de Dados</h3>
            <div class="dice-options">
                <div class="dice-option">
                    <label for="diceQuantity">Qtd:</label>
                    <input type="number" id="diceQuantity" value="1" min="1" max="100">
                </div>
                <div class="dice-option">
                    <label for="attributeBonus">B√¥nus:</label>
                    <select id="attributeBonus">
                        <option value="none">Nenhum</option>
                        <option value="strength">For√ßa</option>
                        <option value="dexterity">Destreza</option>
                        <option value="constitution">Constitui√ß√£o</option>
                        <option value="intelligence">Intelig√™ncia</option>
                        <option value="perception">Percep√ß√£o</option>
                    </select>
                </div>
            </div>
            <div class="dice-buttons">
                <button class="dice-btn re-btn" data-sides="20">d20</button>
                <button class="dice-btn re-btn" data-sides="12">d12</button>
                <button class="dice-btn re-btn" data-sides="10">d10</button>
                <button class="dice-btn re-btn" data-sides="8">d8</button>
                <button class="dice-btn re-btn" data-sides="6">d6</button>
                <button class="dice-btn re-btn" data-sides="4">d4</button>
            </div>
            <div id="dice-result" class="dice-result"></div>
        </div>
    </div>

    <div id="read-document-modal" class="modal">
        <div class="modal-content docs-content">
            <span class="close-btn">&times;</span>
            <h3 id="document-title"></h3>
            <div id="document-content" class="item-description"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- CONFIGURA√á√ÉO FIREBASE ---
            const firebaseConfig = {
                apiKey: "AIzaSyAKUKEyV3iS8QCQpdjtHhDdbiySy2e9RZY",
                authDomain: "rpgterror-90630.firebaseapp.com",
                projectId: "rpgterror-90630",
                storageBucket: "rpgterror-90630.appspot.com",
                messagingSenderId: "569459851763",
                appId: "1:569459851763:web:302afb88d253d14ab25286"
            };
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            // --- REFER√äNCIAS DO DOM ---
            const elements = {
                notificationContainer: document.getElementById('notification-container'),
                campaignNameDisplay: document.getElementById('campaign-name-display'),
                characterImage: document.getElementById('character-image'),
                imageUpload: document.getElementById('image-upload'),
                charNameInput: document.getElementById('char-name'),
                equippedWeapon: document.getElementById('equipped-weapon'),
                healthBar: document.getElementById('health'),
                healthValue: document.getElementById('health-value'),
                increaseHealthBtn: document.getElementById('increase-health-btn'),
                decreaseHealthBtn: document.getElementById('decrease-health-btn'),
                selectedItemDisplay: document.getElementById('selected-item-display'),
                itemDescription: document.getElementById('item-description'),
                inventoryGrid: document.getElementById('inventory-grid'),
                attributes: {
                    strength: document.getElementById('strength'),
                    dexterity: document.getElementById('dexterity'),
                    constitution: document.getElementById('constitution'),
                    intelligence: document.getElementById('intelligence'),
                    perception: document.getElementById('perception'),
                },
                modifiers: {
                    strength: document.getElementById('strength-mod'),
                    dexterity: document.getElementById('dexterity-mod'),
                    constitution: document.getElementById('constitution-mod'),
                    intelligence: document.getElementById('intelligence-mod'),
                    perception: document.getElementById('perception-mod'),
                },
                lifeTotalSpan: document.getElementById('life-total'),
                sanityTotalSpan: document.getElementById('sanity-total'),
                notesTextarea: document.getElementById('notes-textarea'),
                docsBtn: document.getElementById('docs-btn'),
                mapBtn: document.getElementById('map-btn'),
                diceBtn: document.getElementById('dice-btn'),
                audioToggle: document.getElementById('audio-toggle'),
                audioIcon: document.getElementById('audio-icon'),
                backgroundAudio: document.getElementById('background-audio'),
                docsModal: document.getElementById('docs-modal'),
                mapModal: document.getElementById('map-modal'),
                diceModal: document.getElementById('dice-modal'),
                readDocumentModal: document.getElementById('read-document-modal'),
                mapTitle: document.getElementById('map-title'),
                mapImage: document.getElementById('map-image'),
                saveNotesBtn: document.getElementById('save-notes'),
                diceResultDiv: document.getElementById('dice-result'),
                backToCampaignsBtn: document.getElementById('backToCampaigns'),
                chatContainer: document.getElementById('player-chat-container'),
                chatHeader: document.querySelector('.chat-header'),
                chatMessages: document.getElementById('chat-messages'),
                chatInputField: document.getElementById('chat-input-field'),
                sendChatBtn: document.getElementById('send-chat-btn'),
                toggleChatBtn: document.getElementById('toggle-chat-btn'),
                playerFogOfWarCanvas: document.getElementById('player-fog-of-war'),
            };

            // --- ESTADO DA APLICA√á√ÉO ---
            let campaignId, userId, playerDocRef, campaignDocRef;
            let unsubscribePlayer, unsubscribeEvents, unsubscribeCampaign;
            let localInventory = Array(8).fill(null);
            let masterId = null;
            let mapState = { ctx: null, revealedAreas: [] };
            let selectedSlotIndex = -1;
            let isInitialEventsLoad = true;

            const showNotification = (message, type = 'info', duration = 4000) => {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                elements.notificationContainer.appendChild(notification);
                setTimeout(() => notification.remove(), duration);
            };

            const calculateModifier = (score) => {
                const modifier = Math.floor((score - 10) / 2);
                return modifier >= 0 ? `+${modifier}` : modifier;
            };

            const updateAllModifiers = () => {
                for (const attr in elements.attributes) {
                    const score = parseInt(elements.attributes[attr].value);
                    elements.modifiers[attr].textContent = calculateModifier(score);
                }
            };

            auth.onAuthStateChanged((user) => {
                if (user) {
                    userId = user.uid;
                    const urlParams = new URLSearchParams(window.location.search);
                    campaignId = urlParams.get('campaign');
                    if (!campaignId) {
                        window.location.href = 'campaign.html';
                        return;
                    }
                    campaignDocRef = db.collection('campaigns').doc(campaignId);
                    playerDocRef = campaignDocRef.collection('players').doc(userId);
                    initializePlayer();
                } else {
                    window.location.href = 'index.html';
                }
            });

            async function initializePlayer() {
                const playerDoc = await playerDocRef.get();
                if (!playerDoc.exists) {
                    const user = auth.currentUser;
                    const initialData = {
                        name: user.displayName || "Sobrevivente",
                        health: 100, maxHealth: 100,
                        strength: 10, dexterity: 10, constitution: 10, intelligence: 10, perception: 10,
                        notes: "", inventory: Array(8).fill(null), characterImage: ""
                    };
                    await playerDocRef.set(initialData);
                }
                attachListeners();
                setupPlayerMap();
            }

            function attachListeners() {
                if (unsubscribePlayer) unsubscribePlayer();
                unsubscribePlayer = playerDocRef.onSnapshot((doc) => {
                    if (doc.exists) updateUI(doc.data());
                });

                if (unsubscribeEvents) unsubscribeEvents();
                elements.chatMessages.innerHTML = '';
                unsubscribeEvents = campaignDocRef.collection('events')
                    .orderBy('timestamp', 'asc')
                    .onSnapshot((snapshot) => {
                        snapshot.docChanges().forEach(change => {
                            if (change.type === 'added') {
                                const event = { id: change.doc.id, ...change.doc.data() };
                                if (isInitialEventsLoad) {
                                    if (event.type === 'chat' || event.type === 'dice_roll') displayChatMessage(event);
                                } else {
                                    if (event.type === 'chat' || event.type === 'dice_roll') displayChatMessage(event);
                                    else if (event.type === 'item_received' && event.recipientId === userId) showNotification(`Voc√™ recebeu o item: ${event.item.name}!`, 'success');
                                }
                            }
                        });
                        isInitialEventsLoad = false;
                    }, (error) => console.error("Erro no listener de eventos: ", error));

                if (unsubscribeCampaign) unsubscribeCampaign();
                unsubscribeCampaign = campaignDocRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        const campaignData = doc.data();
                        elements.campaignNameDisplay.textContent = `Campanha: ${campaignData.name}`;

                        if (campaignData.active === false && masterId && userId !== masterId) {
                            showNotification("O mestre encerrou a sess√£o.", "error", 10000);
                            setTimeout(() => { window.location.href = 'campaign.html'; }, 3000);
                        }

                        if (campaignData.masterId !== masterId) {
                            masterId = campaignData.masterId;
                        }

                        if (campaignData.activeMapId) {
                            campaignDocRef.collection('maps').doc(campaignData.activeMapId).get().then(mapDoc => {
                                if (mapDoc.exists) {
                                    elements.mapImage.src = mapDoc.data().url;
                                    elements.mapTitle.textContent = mapDoc.data().name;
                                }
                            });
                        } else {
                            elements.mapImage.src = "";
                            elements.mapTitle.textContent = "Nenhum mapa ativo";
                        }
                    } else {
                        showNotification("A campanha foi encerrada ou deletada.", "error", 10000);
                        setTimeout(() => { window.location.href = 'campaign.html'; }, 3000);
                    }
                }, (error) => {
                    showNotification("Conex√£o com a campanha perdida.", "error", 10000);
                    setTimeout(() => { window.location.href = 'campaign.html'; }, 3000);
                });

                const mapStateRef = campaignDocRef.collection('mapState').doc('current');
                mapStateRef.onSnapshot((doc) => {
                    mapState.revealedAreas = doc.exists && doc.data().revealed ? doc.data().revealed : [];
                    drawPlayerFogOfWar();
                });
            }

            function setupPlayerMap() {
                const canvas = elements.playerFogOfWarCanvas;
                const mapImage = elements.mapImage;
                if (!canvas) return;
                mapState.ctx = canvas.getContext('2d');

                const resizeCanvas = () => {
                    if (mapImage.naturalWidth > 0) {
                        const imgRect = mapImage.getBoundingClientRect();
                        canvas.width = imgRect.width;
                        canvas.height = imgRect.height;
                        drawPlayerFogOfWar();
                    }
                };

                mapImage.onload = resizeCanvas;
                window.addEventListener('resize', resizeCanvas);
            }

            function drawPlayerFogOfWar() {
                if (!mapState.ctx) return;
                const { ctx, revealedAreas } = mapState;
                const canvas = elements.playerFogOfWarCanvas;

                if (canvas.width === 0 || canvas.height === 0) return;

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                if (revealedAreas && revealedAreas.length > 0) {
                    ctx.globalCompositeOperation = 'destination-out';
                    revealedAreas.forEach(area => {
                        ctx.fillRect(area.x * canvas.width, area.y * canvas.height, area.w * canvas.width, area.h * canvas.height);
                    });
                    ctx.globalCompositeOperation = 'source-over';
                }
            }

            function displayChatMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message';
                const senderSpan = document.createElement('span');
                senderSpan.className = 'message-sender';
                senderSpan.textContent = message.senderName || 'Sistema';
                if (message.senderId === userId) messageDiv.classList.add('own-message');
                if (message.senderId === masterId) senderSpan.classList.add('master');

                const textP = document.createElement('p');
                textP.className = 'message-text';
                textP.textContent = message.text;

                messageDiv.appendChild(senderSpan);
                messageDiv.appendChild(textP);
                elements.chatMessages.appendChild(messageDiv);
                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            }
            function sendChatMessage() {
                const messageText = elements.chatInputField.value.trim();
                if (!messageText) return;
                const message = { senderId: userId, senderName: elements.charNameInput.value || auth.currentUser.displayName, text: messageText, timestamp: firebase.firestore.FieldValue.serverTimestamp(), type: 'chat' };
                campaignDocRef.collection('events').add(message);
                elements.chatInputField.value = '';
            }
            function updateUI(data) {
                elements.charNameInput.value = data.name || '';
                elements.attributes.strength.value = data.strength || 10;
                elements.attributes.dexterity.value = data.dexterity || 10;
                elements.attributes.constitution.value = data.constitution || 10;
                elements.attributes.intelligence.value = data.intelligence || 10;
                elements.attributes.perception.value = data.perception || 10;
                elements.notesTextarea.value = data.notes || '';
                if (data.characterImage) { elements.characterImage.innerHTML = `<img src="${data.characterImage}" alt="Personagem">`; } else { elements.characterImage.innerHTML = ''; }
                updateCalculatedStats(data);
                if (JSON.stringify(localInventory) !== JSON.stringify(data.inventory)) { localInventory = data.inventory && data.inventory.length === 8 ? data.inventory : Array(8).fill(null); renderInventory(); }
            }
            function updateCalculatedStats(data) {
                updateAllModifiers();
                const constitution = parseInt(elements.attributes.constitution.value);
                const strength = parseInt(elements.attributes.strength.value);
                const intelligence = parseInt(elements.attributes.intelligence.value);
                const dexterity = parseInt(elements.attributes.dexterity.value);
                const lifeTotal = Math.floor((constitution + strength) / 2);
                elements.lifeTotalSpan.textContent = lifeTotal;
                elements.sanityTotalSpan.textContent = intelligence * dexterity;
                elements.healthBar.max = lifeTotal;
                const currentHealth = data ? Math.min(data.health, lifeTotal) : parseInt(elements.healthBar.value);
                elements.healthBar.value = Math.min(currentHealth, lifeTotal);
                elements.healthValue.textContent = `${elements.healthBar.value}/${lifeTotal}`;
                updateHealthBarColor();
            }
            function updateHealthBarColor() {
                const percent = (elements.healthBar.value / elements.healthBar.max) * 100;
                const barFill = document.getElementById('health-bar-fill');
                if (!barFill) return;
                barFill.style.width = percent + '%';
                if (percent > 60) barFill.style.backgroundColor = '#2E7D32';
                else if (percent > 30) barFill.style.backgroundColor = '#FBC02D';
                else barFill.style.backgroundColor = '#C62828';
            }
            function saveData() {
                if (!playerDocRef) return;
                const dataToSave = {
                    name: elements.charNameInput.value,
                    health: parseInt(elements.healthBar.value),
                    maxHealth: parseInt(elements.healthBar.max),
                    strength: parseInt(elements.attributes.strength.value),
                    dexterity: parseInt(elements.attributes.dexterity.value),
                    constitution: parseInt(elements.attributes.constitution.value),
                    intelligence: parseInt(elements.attributes.intelligence.value),
                    perception: parseInt(elements.attributes.perception.value),
                    notes: elements.notesTextarea.value,
                    inventory: localInventory,
                    characterImage: elements.characterImage.querySelector('img')?.src || ''
                };
                playerDocRef.update(dataToSave).catch(error => console.error("Erro ao salvar dados: ", error));
            }

            function discardItem(index) {
                if (confirm(`Tem certeza que deseja descartar ${localInventory[index].name}?`)) {
                    localInventory[index] = null;
                    renderInventory();
                    elements.itemDescription.innerHTML = 'Clique em um item para ver a descri√ß√£o.';
                    elements.selectedItemDisplay.textContent = 'Nenhum';
                    saveData();
                }
            }
            function useHealingItem(index) {
                const item = localInventory[index];
                if (item && item.type === 'healing' && item.healAmount) {
                    adjustHealth(item.healAmount);
                    showNotification(`Voc√™ usou ${item.name} e recuperou ${item.healAmount} de vida.`, 'success');
                    localInventory[index] = null;
                    renderInventory();
                    elements.itemDescription.innerHTML = 'Clique em um item para ver a descri√ß√£o.';
                    elements.selectedItemDisplay.textContent = 'Nenhum';
                    saveData();
                }
            }
            function readDocument(index) {
                const item = localInventory[index];
                if (item && item.type === 'document') { elements.readDocumentModal.querySelector('#document-title').textContent = item.name; elements.readDocumentModal.querySelector('#document-content').innerHTML = `<p>${(item.content || "Este documento parece estar em branco.").replace(/\n/g, '<br>')}</p>`; elements.readDocumentModal.style.display = 'block'; }
            }
            function adjustAmmo(index, amount) {
                const item = localInventory[index];
                if (item && item.type === 'weapon') { if (item.ammoCount === undefined) item.ammoCount = 0; const newAmount = item.ammoCount + amount; item.ammoCount = Math.max(0, newAmount); saveData(); selectItem(index); }
            }
            function selectItem(index) {
                selectedSlotIndex = index;
                document.querySelectorAll('.inventory-slot.selected').forEach(s => s.classList.remove('selected'));
                if (elements.inventoryGrid.children[index]) { elements.inventoryGrid.children[index].classList.add('selected'); }
                const item = localInventory[index];
                if (item) {
                    elements.selectedItemDisplay.textContent = item.name;
                    let descriptionHTML = `<p>${item.description || ''}</p><p><strong>Tipo:</strong> ${item.type || ''}</p>`;
                    if (item.type === 'weapon') { descriptionHTML += ` <div class="ammo-control"> <strong>Muni√ß√£o:</strong> <div class="ammo-buttons"> <button id="decrease-ammo-btn" class="ammo-btn">-</button> <span class="ammo-count">${item.ammoCount || 0}</span> <button id="increase-ammo-btn" class="ammo-btn">+</button> </div> </div> `; }
                    descriptionHTML += `<div class="item-actions">`;
                    switch (item.type) { case 'healing': descriptionHTML += `<button id="use-item-btn" class="re-btn">Usar</button>`; break; case 'document': descriptionHTML += `<button id="read-doc-btn" class="re-btn">Ler</button>`; break; }
                    descriptionHTML += `<button id="discard-item-btn" class="re-btn re-btn-secondary">Descartar</button>`;
                    descriptionHTML += `</div>`;
                    elements.itemDescription.innerHTML = descriptionHTML;
                    document.getElementById('decrease-ammo-btn')?.addEventListener('click', () => adjustAmmo(selectedSlotIndex, -1));
                    document.getElementById('increase-ammo-btn')?.addEventListener('click', () => adjustAmmo(selectedSlotIndex, 1));
                    document.getElementById('use-item-btn')?.addEventListener('click', () => useHealingItem(selectedSlotIndex));
                    document.getElementById('read-doc-btn')?.addEventListener('click', () => readDocument(selectedSlotIndex));
                    document.getElementById('discard-item-btn')?.addEventListener('click', () => discardItem(selectedSlotIndex));
                    if (item.type === 'weapon') { elements.equippedWeapon.innerHTML = `Arma: ${item.name}`; }
                } else { elements.selectedItemDisplay.textContent = 'Nenhum'; elements.itemDescription.innerHTML = 'Clique em um item para ver a descri√ß√£o.'; }
            }
            function renderInventory() {
                elements.inventoryGrid.innerHTML = '';
                for (let i = 0; i < 8; i++) {
                    const item = localInventory[i];
                    const slot = document.createElement('div');
                    slot.className = 'inventory-slot';
                    if (item) {
                        slot.innerHTML = ''; slot.style.backgroundColor = '#222';
                        if (item.image) { slot.style.backgroundImage = `url('${item.image}')`; slot.style.backgroundSize = 'cover'; slot.style.backgroundPosition = 'center'; slot.style.backgroundRepeat = 'no-repeat'; }
                    } else { slot.innerHTML = `<span>+</span>`; slot.style.backgroundImage = 'none'; }
                    if (i === selectedSlotIndex && !item) { selectedSlotIndex = -1; elements.selectedItemDisplay.textContent = 'Nenhum'; elements.itemDescription.innerHTML = 'Clique em um item para ver a descri√ß√£o.'; }
                    slot.addEventListener('click', () => selectItem(i));
                    elements.inventoryGrid.appendChild(slot);
                    if (i === selectedSlotIndex && item) { slot.classList.add('selected'); }
                }
            }

            // --- EVENT LISTENERS ---
            Object.values(elements.attributes).forEach(input => {
                input.addEventListener('input', () => {
                    if (parseInt(input.value) > 20) {
                        input.value = 20;
                    }
                    if (parseInt(input.value) < 1) {
                        input.value = 1;
                    }
                    updateCalculatedStats({ health: elements.healthBar.value });
                });
                input.addEventListener('change', saveData);
            });

            function adjustHealth(amount) {
                let newHealth = parseInt(elements.healthBar.value) + amount;
                newHealth = Math.max(0, Math.min(newHealth, elements.healthBar.max));
                elements.healthBar.value = newHealth;
                updateCalculatedStats({ health: newHealth });
                saveData();
            }
            elements.increaseHealthBtn.addEventListener('click', () => adjustHealth(1));
            elements.decreaseHealthBtn.addEventListener('click', () => adjustHealth(-1));
            elements.sendChatBtn.addEventListener('click', sendChatMessage);
            elements.chatInputField.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatMessage(); });
            elements.toggleChatBtn.addEventListener('click', () => { elements.chatContainer.classList.toggle('collapsed'); });
            elements.characterImage.addEventListener('click', () => elements.imageUpload.click());
            elements.imageUpload.addEventListener('change', e => { if (e.target.files[0]) { const reader = new FileReader(); reader.onload = event => { elements.characterImage.innerHTML = `<img src="${event.target.result}" alt="Personagem">`; saveData(); }; reader.readAsDataURL(e.target.files[0]); } });
            elements.docsBtn.addEventListener('click', () => { elements.docsModal.style.display = 'block'; });
            elements.saveNotesBtn.addEventListener('click', saveData);
            elements.mapBtn.addEventListener('click', () => { elements.mapModal.style.display = 'block'; });
            elements.diceBtn.addEventListener('click', () => { elements.diceModal.style.display = 'block'; });
            elements.audioToggle.addEventListener('click', () => { const audio = elements.backgroundAudio; if (audio.paused) { audio.play().catch(e => console.log("Playback falhou", e)); elements.audioIcon.textContent = 'üîä'; } else { audio.pause(); elements.audioIcon.textContent = 'üîá'; } });

            document.querySelectorAll('.dice-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const diceAudio = document.getElementById('dice-audio');
                    if (diceAudio) { diceAudio.currentTime = 0; diceAudio.play(); }

                    const sides = parseInt(btn.dataset.sides);
                    const quantity = parseInt(document.getElementById('diceQuantity').value) || 1;
                    const attributeBonusSelect = document.getElementById('attributeBonus');
                    const selectedAttribute = attributeBonusSelect.value;

                    let rolls = [];
                    let baseTotal = 0;
                    for (let i = 0; i < quantity; i++) {
                        const roll = Math.floor(Math.random() * sides) + 1;
                        rolls.push(roll);
                        baseTotal += roll;
                    }

                    let modifier = 0;
                    let modifierText = "";
                    if (selectedAttribute !== 'none') {
                        const score = parseInt(elements.attributes[selectedAttribute].value);
                        modifier = Math.floor((score - 10) / 2);
                        const attrName = attributeBonusSelect.options[attributeBonusSelect.selectedIndex].text;
                        modifierText = ` (${attrName})`;
                    }

                    const finalTotal = baseTotal + modifier;

                    let rollText;
                    if (quantity === 1) {
                        rollText = `rolou 1d${sides}${modifierText}: ${baseTotal}`;
                        if (modifier !== 0) rollText += ` ${modifier > 0 ? '+' : '-'} ${Math.abs(modifier)} = ${finalTotal}`;
                    } else {
                        rollText = `rolou ${quantity}d${sides}${modifierText}: [${rolls.join(', ')}]`;
                        if (modifier !== 0) rollText += ` ${modifier > 0 ? '+' : '-'} ${Math.abs(modifier)}`;
                        rollText += ` = ${finalTotal}`;
                    }

                    elements.diceResultDiv.textContent = `Resultado: ${finalTotal}`;
                    const message = { senderId: userId, senderName: elements.charNameInput.value || auth.currentUser.displayName, text: rollText, timestamp: firebase.firestore.FieldValue.serverTimestamp(), type: 'dice_roll' };
                    campaignDocRef.collection('events').add(message);
                });
            });

            document.querySelectorAll('.close-btn').forEach(btn => { btn.onclick = () => { btn.closest('.modal').style.display = 'none'; if (btn.closest('.modal').id === 'docs-modal') saveData(); } });
            window.onclick = (e) => { if (e.target.classList.contains('modal')) { e.target.style.display = 'none'; if (e.target.id === 'docs-modal') saveData(); } }
            elements.backToCampaignsBtn.addEventListener('click', () => { window.location.href = 'campaign.html'; });
        });
    </script>
</body>

</html>